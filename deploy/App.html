<!DOCTYPE html>
<html>
<head>
    <title>DRI app</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",weeks:[],numberOfWeeks:16,arrOfCreationDateFilters:[],arrOfFixedAndLimitedByCreationDateFilters:[],created:[],fixedWithinTTR:[],ttr1:28,ttr2:84,launch:function(){this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait.This may take long..."}),this._myMask.show(),this.getDates(),this.createFilters(),this.makeStore()},getDates:function(){var now=new Date,today=now.getDay(),saturday=6,padding=1,howFarBack=this.numberOfWeeks+padding,saturdayDates=[],closestSaturday=null,prevSaturday=null,weeks=[],daysFromLastSaturday=today-saturday;closestPastSaturday=new Date(now-864e5*daysFromLastSaturday-6048e5),saturdayDates.push(Rally.util.DateTime.format(closestPastSaturday,"Y-m-d")),console.log("today:",today,"daysFromLastSaturday:",daysFromLastSaturday,"closestPastSaturday:",closestPastSaturday);for(var i=1;howFarBack>i;i++){var prevSaturday=new Date(closestPastSaturday-6048e5);saturdayDates.push(Rally.util.DateTime.format(prevSaturday,"Y-m-d")),closestPastSaturday=prevSaturday}console.log("saturdayDates:",saturdayDates);for(var i=0;saturdayDates.length-1>i;i++){var week={};week.end=saturdayDates[i],week.start=saturdayDates[i+1],this.weeks.push(week)}_.each(this.weeks,function(week){console.log("start:",week.start,"end:",week.end)}),console.log("--------",weeks.length)},createFilters:function(){var tagFilter,codeResolitionFilter,closedFilter,fixedFilter,closedDateFilters=[],creationDateFilters=[];tagFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Tags.Name",operator:"contains",value:"Customer Voice"}),closedFilter=tagFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"State",value:"Closed"})),codeResolitionFilter=Rally.data.wsapi.Filter.or([{property:"Resolution",value:"Code Change"},{property:"Resolution",value:"Database/Metadata Change"},{property:"Resolution",value:"Configuration Change"}]),fixedFilter=closedFilter.and(codeResolitionFilter),_.each(this.weeks,function(week){var creationDateFilter=Rally.data.wsapi.Filter.and([{property:"CreationDate",operator:">=",value:week.start},{property:"CreationDate",operator:"<",value:week.end}]);this.arrOfCreationDateFilters.push(tagFilter.and(creationDateFilter)),this.arrOfFixedAndLimitedByCreationDateFilters.push(fixedFilter.and(creationDateFilter))},this),console.log(this.arrOfCreationDateFilters.length," Creation Date Filters--------"),_.each(this.arrOfCreationDateFilters,function(filter){console.log(""+filter)},this),console.log(this.arrOfFixedAndLimitedByCreationDateFilters.length," Fixed Filters limited by Creation Dates-----------"),_.each(this.arrOfFixedAndLimitedByCreationDateFilters,function(filter){console.log(""+filter)},this)},makeStore:function(){this.concatArraysOfFilters=this.arrOfCreationDateFilters.concat(this.arrOfFixedAndLimitedByCreationDateFilters),this.defectStore=Ext.create("Rally.data.wsapi.Store",{model:"Defect",fetch:["Name","State","FormattedID","CreationDate","ClosedDate"],limit:1/0}),this.applyFiltersToStore(0)},applyFiltersToStore:function(i){this.defectStore.addFilter(this.concatArraysOfFilters[i]),this.defectStore.load({scope:this,callback:function(records,operation){operation.wasSuccessful()&&(this.numberOfWeeks>i?this.created.push(records.length):this.fixedWithinTTR.push(this.getFixedDefectsWithinTTR(records)),this.defectStore.clearFilter(records.length),this.concatArraysOfFilters.length-1>i?this.applyFiltersToStore(i+1):this.makeCustomStore())}})},getFixedDefectsWithinTTR:function(records){var closedDefectsWithinTTR1=[],closedDefectsWithinTTR2=[],closedDefectsWithinAllTTRs=[],arrayOfDataObjects=[];return _.each(records,function(record){var created=new Date(record.get("CreationDate")),closed=new Date(record.get("ClosedDate")),diff=Math.floor((closed-created)/864e5);this.ttr2>=diff&&closedDefectsWithinTTR2.push(record),this.ttr1>=diff&&closedDefectsWithinTTR1.push(record)},this),closedDefectsWithinAllTTRs.push(closedDefectsWithinTTR1.length),closedDefectsWithinAllTTRs.push(closedDefectsWithinTTR2.length),console.log("closedDefectsWithinAllTTRs",closedDefectsWithinAllTTRs),closedDefectsWithinAllTTRs},makeCustomStore:function(){console.log("created",this.created),console.log("fixedWithinTTR",this.fixedWithinTTR),this.fixedWithinTTR=_.flatten(this.fixedWithinTTR);for(var fixedWithinTTR1=[],fixedWithinTTR2=[],index=0;this.fixedWithinTTR.length>index;index++)0==index%2?fixedWithinTTR1.push(this.fixedWithinTTR[index]):fixedWithinTTR2.push(this.fixedWithinTTR[index]);var startDates=[],endDates=[],dri1=[],dri2=[],combinedArr=[];console.log("fixedWithinTTR1",fixedWithinTTR1),console.log("fixedWithinTTR2",fixedWithinTTR2);for(var f=0,c=0;fixedWithinTTR1.length>f;f++,c++)dri1.push((100*(fixedWithinTTR1[f]/this.created[c])).toFixed(2)+"%");for(var f=0,c=0;fixedWithinTTR2.length>f;f++,c++)dri2.push((100*(fixedWithinTTR2[f]/this.created[c])).toFixed(2)+"%");console.log("dri1",dri1),console.log("dri2",dri2),combinedArr.push(this.created),combinedArr.push(fixedWithinTTR1),combinedArr.push(fixedWithinTTR2),combinedArr.push(dri1),combinedArr.push(dri2),combinedArr.push(startDates),combinedArr.push(endDates),_.each(this.weeks,function(week){startDates.push(week.start),endDates.push(week.end)}),console.log("combinedArr",combinedArr);var zippedChunks=_.zip(combinedArr);console.log("zippedChunks",zippedChunks);for(var arrayOfObjects=[],i=0;zippedChunks.length>i;i++){for(var o={},j=0;zippedChunks[i].length>j;j++)o[j]=zippedChunks[i][j];arrayOfObjects.push(o)}console.log("arrayOfObjects",arrayOfObjects),this.makeGrid(arrayOfObjects)},makeGrid:function(data){this._myMask.hide(),this.add({xtype:"rallygrid",itemId:"defectGrid",store:Ext.create("Rally.data.custom.Store",{data:data}),columnCfgs:[{text:"Start Week",dataIndex:"5"},{text:"End Week",dataIndex:"6"},{text:"Created Defects",dataIndex:"0"},{text:"Fixed Defects (TTR <= 4 weeks)",dataIndex:"1"},{text:"Fixed Defects (TTR <= 12 weeks)",dataIndex:"2"},{text:"4 Week DRI",dataIndex:"3"},{text:"12 Week DRI",dataIndex:"4"}],showPagingToolbar:!1})}});

            Rally.launchApp('CustomApp', {
                name:"DRI app",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .mystyle{background:red}.app .rally-grid .x-grid-data-row:nth-child(-n+12) .x-grid-cell:last-child{color:#808080}.app .rally-grid .x-grid-data-row:nth-child(-n+4) .x-grid-cell:nth-child(7){color:#808080}.app .rally-grid .x-grid-data-row:nth-child(-n+4) .x-grid-cell:nth-child(5){color:#808080}.app .rally-grid .x-grid-data-row:nth-child(-n+4) .x-grid-cell:nth-child(6){color:#808080}
    </style>
</head>
<body>
</body>
</html>
